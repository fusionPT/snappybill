//
//facturarapida.net v0.5
//
$(document).ready(function(){function f(){return t?!0:!1}function l(){$("#invoice-table tr.added_tax").remove();tax={name:"IVA",value:"21"};m(tax);tax={name:"IRPF",value:"-21"};m(tax)}function c(){d=1;$("#invoice").find("input[type=text], textarea").val("");$("#invoice-title").val("Factura");$("#invoice-date").val($("#invoice-date").attr("placeholder"));l();$("#invoice-table .cantidad").val(0);$("#invoice-table .coste").val(0);$("#invoice-table tr.row:not(:first)").remove();g()}function h(){var t=0,n=Object.keys(e.invoices);for(i in n){console.log(Math.round(n[i].replace("invoice","")));Math.round(n[i].replace("invoice",""))>=t&&(t=Math.round(n[i].replace("invoice","")))}return t}function p(e){$("#inv").val(e)}function v(e){d++;typeof e=="undefined"&&(e={coste:"0",cantidad:"0",description:""});var t="<tr class='row'><td class='article'><input class='description' type='text' name='description-value' size='40' placeholder='ej. PÃ¡gina web' value='{DESCRIPTION}'/><input class='hidden-description' type='hidden' value=''/></td><td><input class='cantidad' type='text' name='cost' placeholder='Cant.' size='2' value='{CANTIDAD}'/></td><td><input class='coste' type='text' name='qty' placeholder='Coste' size='2' value='{COSTE}'/></td><td class='value'><span class='precio'>0</span><input class='precio-hidden' type='hidden' name='price' value='0'/></td><td class='insert'><a class='delete-row' href='#'>Delete Row</a></td></tr>";t=t.replace("{COSTE}",e.coste.replace("'","\\'"));t=t.replace("{CANTIDAD}",e.cantidad.replace("'","\\'"));t=t.replace("{DESCRIPTION}",e.description.replace("'","\\'"));$("#invoice-table > tbody > tr.row:last").after(t)}function m(e){typeof e=="undefined"&&(e={name:"Tax",value:"0"});template='<tr class=\'added_tax\'><td class="noborder">&nbsp;</td><td class="tax"><a class="delete-tax">Delete</a></td><td><span class="tax"><input class="tax_name" style="width:30px;" type="text" name="tax_names[]" placeholder="Tax" value="{TAX_NAME}" size="3"></span><input class="tax_value iva" type="text" name="tax_values[]" placeholder="0" value="{TAX_VALUE}" size="3"></td><td class="tax_total">0</td><input class="tax_total-hidden" type="hidden" name="tax_total[]" value="0"></tr>';template=template.replace("{TAX_NAME}",e.name.replace("'","\\'"));template=template.replace("{TAX_VALUE}",e.value.replace("'","\\'"));$("#invoice-table tr.add_tax_tr").before(template)}function g(){var e=0;$("#invoice-table > tbody > tr.row").each(function(){n=$(this).find("input.cantidad").val();r=$(this).find("input.coste").val();s=+r*+n;$(this).find(".precio").text(s);$(this).find(".precio-hidden").val(s);e+=s});var t=0;$(".added_tax").each(function(n,r){var i=y($("input.tax_value").eq(n).val()/100*e);t+=i;$(".tax_total-hidden").eq(n).val(i);$(".tax_total").eq(n).html(i)});total=e+t;$(".subtotal").text(e);$(".total").text(y(total));$(".subtotal-hidden").val(e);$(".total-hidden").val(y(total))}function y(e){return Math.round(e*100)/100}function b(){localStorage.setItem("Invoices_DS",JSON.stringify(e))}function w(){var n={},r=[];n.title=$("#invoice-title").val();n.date=$("#invoice-date").val();n.invoice_num=$("#inv").val();if(!n.invoice_num){alert("please specify invoice number");return!1}n.client={};n.client.name=$("#cname").val();n.client.email=$("#cemail").val();n.client.tel=$("#ctel").val();n.user={};n.user.name=$("#name").val();n.user.email=$("#email").val();n.user.tel=$("#tel").val();n.taxes=[];$(".added_tax").each(function(e,t){n.taxes.push({name:$("input.tax_name").eq(e).val(),value:$("input.tax_value").eq(e).val()})});n.notas=$("#invoice-notas").val();$(".row").each(function(e,t){r[e]={description:$("input.description").eq(e).val(),cantidad:$(".cantidad").eq(e).val(),coste:$(".coste").eq(e).val()}});n.items=r;Object.prototype.toString.call(e.invoices)!=="[object Object]"&&(e.invoices={});if(typeof e.invoices["invoice"+n.invoice_num]!="undefined"&&!confirm("do you really want to overwrite the invoice N"+n.invoice_num+"?"))return;e.invoices["invoice"+n.invoice_num]=n;b();N();t=!1}function E(t){(!f()||confirm("There are unsaved changes, do you want to proceed?"))&&c();if(typeof e.invoices["invoice"+t]=="undefined"){alert("No such invoice");return!1}var n=e.invoices["invoice"+t];$("#name").val(n.user.name);$("#email").val(n.user.email);$("#tel").val(n.user.tel);$("#cname").val(n.client.name);$("#cemail").val(n.client.email);$("#ctel").val(n.client.tel);$("#inv").val(n.invoice_num);$("#invoice-notas").val(n.notas);$("#invoice-title").val(n.title);var r=Object.keys(n.items);for(i in r)v(n.items[r[i]]);r.length&&$("#invoice-table tr.row:first").remove();if(n.taxes.length){$("#invoice-table tr.added_tax").remove();for(i in n.taxes)m(n.taxes[i])}g()}function S(t){if(typeof e.invoices["invoice"+t]=="undefined"){alert("No such invoice");return!1}if(confirm("Do you really want to delete invoice N"+t+"?")){delete e.invoices["invoice"+t];b();N()}}function x(){e=JSON.parse(localStorage.getItem("Invoices_DS"));if(Object.prototype.toString.call(e)!=="[object Object]"){e={};e.invoices={};b()}}function T(e){var t="<ul>",n=[];for(var r in e)n.push(r);n.reverse();for(var r in n)t+="<li data-invoice-num='"+e[n[r]].invoice_num+"'><span class='inv_title'>"+e[n[r]].invoice_num+" </span><br/><span class='inv_date'>"+e[n[r]].date+"</span><br/><span class='inv_delete delete-row'>Delete</span></li>";t+="</ul>";return t}function N(){var t=T(e.invoices);$("#invoices").html(t)}var e={},t=!1,n=0,r=0,s=0,o=0,u=0,a={};$("#descargar").click(function(){row_html=$("#invoice-table tbody").html();$(".html-hidden").val(row_html);return!0});$("#guardar").click(function(e){w();return!1});$("#create_new").click(function(e){if(!f()||confirm("There are unsaved changes, do you want to proceed?")){c();p(h()+1)}return!1});$(document).on("click","#invoices ul li .inv_title",function(e){E($(this).parent().attr("data-invoice-num"))});$(document).on("click","#invoices ul li .inv_delete",function(e){S($(this).parent().attr("data-invoice-num"))});var d=1;$("#invoice-table").on("click",".delete-tax",function(e){var t=$(this).closest("tr");t.remove();g();e.preventDefault()});$(".add_tax").on("click",function(e){m();e.preventDefault()});$(".add-row").on("click",function(e){d++;v();e.preventDefault()});$("#invoice-table").on("click",".delete-row",function(e){var t=$(this).closest("tr");if(d>1){d--;t.remove();g()}else alert("You can't delete the only row!");e.preventDefault()});$(document).on("change","div input",function(e){t=!0;e.target.className!=="description"&&g()});$(document).on("keyup","div input",function(e){var n=$("html").find("input:text");$.each(n,function(){$(this).attr("value",$(this).val())});t=!0;e.target.className!=="description"&&g()});x();c();N()});